/*****************************************************************
* Copyright (C) 2017 60Plus Technology Co.,Ltd.*
******************************************************************
* attribute.c
*
* DESCRIPTION:
*     Network attribute1
* AUTHOR:
*     Ziming
* CREATED DATE:
*     2018/12/21
* REVISION:
*     v0.1
*
* MODIFICATION HISTORY
* --------------------
* $Log:$
*
*****************************************************************/
/*************************************************************************************************************************
 *                                                       INCLUDES                                                        *
 *************************************************************************************************************************/
#include <string.h>
#include "loraConfig.h"
#include "OS_flash.h"
#include "attribute.h"
/*************************************************************************************************************************
 *                                                        MACROS                                                         *
 *************************************************************************************************************************/
#ifdef SELF_ORGANIZING_NETWORK
#define MAC_BASE_ADDRESS_1            0x1ff80050
#define MAC_BASE_ADDRESS_2            0x1ff80054
#define MAC_BASE_ADDRESS_3            0x1ff80064
#endif
/*************************************************************************************************************************
 *                                                      CONSTANTS                                                        *
 *************************************************************************************************************************/
 
/*************************************************************************************************************************
 *                                                       TYPEDEFS                                                        *
 *************************************************************************************************************************/
 
/*************************************************************************************************************************
 *                                                   GLOBAL VARIABLES                                                    *
 *************************************************************************************************************************/
 
/*************************************************************************************************************************
 *                                                  EXTERNAL VARIABLES                                                   *
 *************************************************************************************************************************/
t_nwkAtt    nwkAttribute;
/*************************************************************************************************************************
 *                                                    LOCAL VARIABLES                                                    *
 *************************************************************************************************************************/
 
/*************************************************************************************************************************
 *                                                 FUNCTION DECLARATIONS                                                 *
 *************************************************************************************************************************/
 
/*************************************************************************************************************************
 *                                                   PUBLIC FUNCTIONS                                                    *
 *************************************************************************************************************************/
 
/*************************************************************************************************************************
 *                                                    LOCAL FUNCTIONS                                                    *
 *************************************************************************************************************************/


/*****************************************************************
* DESCRIPTION: readMacAddr
*     
* INPUTS:
*     
* OUTPUTS:
*     
* NOTE:
*     null
*****************************************************************/
void readMacAddr( void )
{
#ifdef SELF_ORGANIZING_NETWORK
    uint8_t temp = 0;
    for( uint8_t offset = 0; offset < 3; offset++ )
    {
        for( uint8_t count = 0; count < 4; count++ )
        {
            if( offset < 2 )
            {
                nwkAttribute.m_mac[temp++] = (uint8_t)(*(uint32_t *)(MAC_BASE_ADDRESS_1 + offset*4) >> (24 - count*8));
            }
            else
            {
                nwkAttribute.m_mac[temp++] = (uint8_t)(*(uint32_t *)(MAC_BASE_ADDRESS_3) >> (24 - count*8));
            }
        }
    }
#endif
}

/*****************************************************************
* DESCRIPTION: nwkAttributeRead
*     
* INPUTS:
*     
* OUTPUTS:
*     
* NOTE:
*     null
*****************************************************************/
void nwkAttributeRead( void )
{
    memset( &nwkAttribute, 0, sizeof(t_nwkAtt) );
    flashReadData( NETWORK_ATTRIBUTE_ADDR, (uint8_t *)&nwkAttribute, sizeof(t_nwkAtt)/sizeof(uint8_t) );
#ifdef SELF_ORGANIZING_NETWORK
    readMacAddr();
#endif
}

/*****************************************************************
* DESCRIPTION: nwkAttributeSave
*     
* INPUTS:
*     
* OUTPUTS:
*     
* NOTE:
*     null
*****************************************************************/
void nwkAttributeSave( void )
{
    static t_nwkAtt nwkAttributeOld;
    flashReadData( NETWORK_ATTRIBUTE_ADDR, (uint8_t *)&nwkAttributeOld, sizeof(t_nwkAtt)/sizeof(uint8_t) );
    if( memcmp(&nwkAttributeOld, &nwkAttribute, sizeof(t_nwkAtt)) != 0 )
    {
        memcpy( &nwkAttributeOld, &nwkAttribute, sizeof(t_nwkAtt) );
        flashWriteData( NETWORK_ATTRIBUTE_ADDR, (uint8_t *)&nwkAttribute, sizeof(t_nwkAtt)/sizeof(uint8_t) );
    }
    
}
/*****************************************************************
* DESCRIPTION: nwkAttributeErase
*     
* INPUTS:
*     
* OUTPUTS:
*     
* NOTE:
*     null
*****************************************************************/
void nwkAttributeErase( void )
{
    uint8_t size = 0;
    if( sizeof(t_nwkAtt)%sizeof(uint32_t) )
    {
        size = 1;
    }
    flashEraseData( NETWORK_ATTRIBUTE_ADDR, sizeof(t_nwkAtt)/sizeof(uint32_t) + size );
}


/*****************************************************************
* DESCRIPTION: resetAttribute
*     
* INPUTS:
*     
* OUTPUTS:
*     
* NOTE:
*     null
*****************************************************************/
void resetAttribute( void )
{
     memset( &nwkAttribute, 0, sizeof(t_nwkAtt) );
     nwkAttributeErase();
}
/****************************************************** END OF FILE ******************************************************/
